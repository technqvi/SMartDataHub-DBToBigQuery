demo-version
https://cloud.google.com/blog/products/data-analytics/bigquery-gains-change-data-capture-functionality
https://protobuf.dev/getting-started/pythontutorial/
https://console.cloud.google.com/apis/library/bigquerystorage.googleapis.com?project=pongthorn


https://pypi.org/project/google-cloud-bigquery-storage/
pip install google-cloud-bigquery-storage==2.24.0

pip install protobuf==3.20.3  (tensorflow 2.12)
https://github.com/protocolbuffers/protobuf/tree/main/python

install window compile software
https://github.com/protocolbuffers/protobuf/releases/tag/v25.1


-----------------------------------------------------------------------------
incident script

CREATE OR REPLACE TABLE `SMartDataAnalytics.incident` (
 incident_id INT64,
 inventory_id INT64,
 incident_type STRING,
 service_type STRING,
 severity  STRING,
 status  STRING,
 open_datetime TIMESTAMP,
 close_datetime TIMESTAMP,
 update_at TIMESTAMP
)
PARTITION BY DATE_TRUNC(open_datetime, MONTH)
CLUSTER BY  open_datetime,status,severity,incident_type
OPTIONS(max_staleness = INTERVAL 0 MINUTE);

ALTER table SMartDataAnalytics.incident   
ADD primary key(incident_id) NOT ENFORCED,
ADD FOREIGN KEY(inventory_id) references SMartDataAnalytics.inventory(inventory_id) NOT ENFORCED;
-------------------------------------------



ALTER TABLE `SMartDataAnalytics.incident`
SET OPTIONS (
 max_staleness = INTERVAL 0 MINUTE);
-------------------------------------------------------------------------------------

C:\protoc-25.1-win64\bin
run compile proto file to get xxxx_pb2.py
d:
cd D:\PythonDev\MyQuantFinProject\SMartDataHub-DBToBigQuery\bq_storage_api
C:\protoc-25.1-win64\bin\protoc.exe  --python_out=. incident_data.proto


SELECT * FROM `pongthorn.SMartDataAnalytics.incident` 


https://www.epochconverter.com/

truncate table pongthorn.SMartDataAnalytics.incident

#Replace CDC_Demo_Dataset with your preferred dataset name
SELECT
 upsert_stream_apply_watermark
FROM `SMartDataAnalytics`.INFORMATION_SCHEMA.TABLES
WHERE
 table_name = "incident"



test 
date_created>='2024-01-17' and content_type_id=18

SELECT
 incident_id,status, IF(date(close_datetime) ='1970-01-01' , null, close_datetime)
from `pongthorn.SMartDataAnalytics.incident`  
